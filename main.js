!function(t){var e={};function s(a){if(e[a])return e[a].exports;var i=e[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=t,s.c=e,s.d=function(t,e,a){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(a,i,function(e){return t[e]}.bind(null,i));return a},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([function(t,e,s){},function(t,e,s){"use strict";s.r(e);s(0);function a(t,e){const s={X:null,Y:null};for(let a=0;a<e.length;a+=1)if(s.Y=e[a].indexOf(t),-1!==s.Y){s.X=a;break}return s}function i(t,e){let s;return t.character.level>e.character.level&&(s=-1),t.character.level===e.character.level&&(s=0),t.character.level<e.character.level&&(s=1),s}function n(t,e){let s;return t.distance>e.distance&&(s=1),t.distance===e.distance&&(s=0),t.distance<e.distance&&(s=-1),s}class l{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",t=>this.onNewGameClick(t)),this.saveGameEl.addEventListener("click",t=>this.onSaveGameClick(t)),this.loadGameEl.addEventListener("click",t=>this.onLoadGameClick(t)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(e=t,s=this.boardSize,0===e?"top-left":e===s-1?"top-right":e===s**2-s?"bottom-left":e===s**2-1?"bottom-right":e<s?"top":Number.isInteger(e/s)?"left":Number.isInteger((e+1)/s)?"right":e>s**2-s?"bottom":"center")),a.addEventListener("mouseenter",t=>this.onCellEnter(t)),a.addEventListener("mouseleave",t=>this.onCellLeave(t)),a.addEventListener("click",t=>this.onCellClick(t)),this.boardEl.appendChild(a)}var e,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const n=document.createElement("div");n.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),n.style.width=s.character.health+"%",i.appendChild(n),a.appendChild(i),t.appendChild(a)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach(t=>t.call(null,e))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach(t=>t.call(null,e))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach(t=>t.call(null,e))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach(t=>t.call(null))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach(t=>t.call(null))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach(t=>t.call(null))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t,e="yellow"){this.deselectCell(t),this.cells[t].classList.add("selected","selected-"+e)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter(t=>t.startsWith("selected")))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise(s=>{const a=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",()=>{a.removeChild(i),s()})})}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class o{constructor(t,e="generic"){if(this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,new.target===o.prototype.constructor)throw new Error("Нельзя использовать вызов new Character()")}static levelUp(t=null){this.level+=t;let e=Math.max(this.attack,this.attack*(80+this.health)/100);e=Math.round(e),this.attack=e;let s=Math.max(this.defence,this.defence*(80+this.health)/100);s=Math.round(s),this.defence=s,this.health+=80,this.health>100&&(this.health=100)}}class r extends o{constructor(...t){if(super(...t,"bowman"),this.attack=25,this.defence=25,this.step=2,this.stepAttack=2,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class h extends o{constructor(...t){if(super(...t,"swordsman"),this.attack=40,this.defence=10,this.step=4,this.stepAttack=1,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class c extends o{constructor(...t){if(super(...t,"magician"),this.attack=10,this.defence=40,this.step=1,this.stepAttack=4,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class m{constructor(t){this.characters=t}}function d(t,e,s){const a=function*(t,e){for(;;){const s=Math.floor(Math.random()*e)+1,a=new(t[Math.floor(Math.random()*t.length)])(s);yield a}}(t,e),i=[];for(let t=0;t<s;t+=1)i.push(a.next().value);return new m(i)}class g extends o{constructor(...t){if(super(...t,"daemon"),this.attack=10,this.defence=40,this.step=1,this.stepAttack=4,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class p extends o{constructor(...t){if(super(...t,"undead"),this.attack=40,this.defence=10,this.step=4,this.stepAttack=1,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class u extends o{constructor(...t){if(super(...t,"vampire"),this.attack=25,this.defence=25,this.step=2,this.stepAttack=2,this.level>1)for(let t=1;t<this.level;t+=1)o.levelUp.call(this)}}class S{constructor(t,e){if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}class y{constructor(){this.stepUser=!0,this.lostIndex=-1,this.players=[],this.enemies=[],this.playerTypes=[],this.enemyTypes=[],this.unitAssign=!1,this.point={X:null,Y:null},this.matrix=void 0,this.cursorStatus=!0,this.step=void 0,this.stepAttack=void 0,this.animation=!1,this.playerVictory=!1,this.countMembers=4,this.level=1,this.countThemes=0,this.newGame=!1,this.score=0,this.maxScore=0,this.loadGame=!1}from(t){return this.stepUser=t.stepUser,this.lostIndex=t.lostIndex,this.players=t.players,this.enemies=t.enemies,this.playerTypes=t.playerTypes,this.enemyTypes=t.enemyTypes,this.unitAssign=t.unitAssign,this.point=t.point,this.matrix=t.matrix,this.cursorStatus=t.cursorStatus,this.step=t.step,this.stepAttack=t.stepAttack,this.animation=t.animation,this.playerVictory=t.playerVictory,this.countMembers=t.countMembers,this.level=t.level,this.countThemes=t.countThemes,this.newGame=t.newGame,this.score=t.score,this.maxScore=t.maxScore,this.loadGame=t.loadGame,null}}var f={auto:"auto",pointer:"pointer",crosshair:"crosshair",notallowed:"not-allowed"};var v={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class C{constructor(t,e){this.gamePlay=t,this.stateService=e,this.gameState=new y}init(){const{countMembers:t}=this.gameState,{level:e}=this.gameState,{countThemes:s}=this.gameState,a=Object.values(v),i=a[e-1-s*a.length];let n;Number.isInteger(e/a.length)&&(this.gameState.countThemes+=1),this.gamePlay.drawUi(i),this.gameState.matrix=function(t){const e=[];for(let s=0;s<t;s+=1){const a=[];for(let e=0;e<t;e+=1){const i=t*s+e;a.push(i)}e.push(a)}return e}(this.gamePlay.boardSize);const l=function(t){const e={player:[],enemy:[]},s=t-1,a=t**2-s;for(let i=0;i<a;i+=1)Number.isInteger(i/t)&&(e.player.push(i),e.player.push(i+1),e.enemy.push(i+s-1),e.enemy.push(i+s));return e}(this.gamePlay.boardSize);if(this.gameState.playerVictory){console.log("Работаем с выжившей командой");const t=this.gameState.players.map(t=>t.character);n=new m(t)}else if(this.gameState.newGame){console.log("Создаем команду (слушателей не добавляем)");n=d([r,h,c],e,t)}else{console.log("Запуск слушателей и создание команды"),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGame.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGame.bind(this));n=d([r,h,c],e,t)}const o=d([g,p,u],e,t);let S,y;this.gameState.loadGame?(S=this.gameState.players,y=this.gameState.enemies):(S=C.assignPositions(n,l.player),y=C.assignPositions(o,l.enemy)),this.gamePlay.redrawPositions([...S,...y]),this.gameState.players.length>0&&(this.gameState.players.length=0,this.gameState.playerTypes.length=0),this.gameState.players.push(...S),this.gameState.enemies.push(...y);const f=new Set;n.characters.forEach(t=>f.add(t.type)),this.gameState.playerTypes=Array.from(f),f.clear(),o.characters.forEach(t=>f.add(t.type)),this.gameState.enemyTypes=Array.from(f),console.log(this.gameState)}onCellClick(t){if(this.gameState.animation)return;this.gameState.stepUser&&(console.log("-----------------------------"),console.log("Ходит игрок"));const e=[...this.gameState.players,...this.gameState.enemies];console.log("Текущее состояние команд",e);const s=e.find(e=>e.position===t);if(this.gameState.cursorStatus){if(!s&&this.gameState.unitAssign){console.log("Переместился на другую клекту");const s=e.find(t=>t.position===this.gameState.lostIndex),a=e.indexOf(s);e[a].position=t,this.gamePlay.redrawPositions(e),this.gamePlay.deselectCell(this.gameState.lostIndex),this.gamePlay.deselectCell(t),this.gameState.unitAssign=!1,this.gameState.lostIndex=-1,this.gameState.point={X:null,Y:null},this.gameState.step=void 0,this.gameState.stepAttack=void 0,this.gameState.stepUser?this.gameState.stepUser=!1:this.gameState.stepUser=!0,this.gamePlay.setCursor(f.auto),this.gameState.stepUser||(console.log("-----------------------------"),console.log("Ходит противник"),this.stepComputer())}if(s){const i={};this.gameState.stepUser?(i.type=this.gameState.playerTypes,i.enemy=this.gameState.enemies):(i.type=this.gameState.enemyTypes,i.enemy=this.gameState.players);const n=i.type.includes(s.character.type);if(this.gameState.unitAssign&&!n)return console.log("Напал на противника",s),this.attackOnUnit(e,t,i),void console.log("Сейчас будет ретурн для онклик");n?(console.log("Выбрал себе unit (нажал на него)",s),this.gameState.lostIndex>-1&&this.gamePlay.deselectCell(this.gameState.lostIndex),this.gamePlay.selectCell(t),this.gameState.lostIndex=t,this.gameState.unitAssign=!0,this.gameState.point=a(t,this.gameState.matrix),this.gameState.step=s.character.step,this.gameState.stepAttack=s.character.stepAttack,this.gamePlay.setCursor(f.pointer)):l.showError("Нельзя выбирать игроков противника")}}else l.showError("Недопустимое действие")}onCellEnter(t){let e;e=this.gameState.stepUser?this.gameState.enemyTypes:this.gameState.playerTypes;const s=[...this.gameState.players,...this.gameState.enemies].find(e=>e.position===t);if(s){const e=C.getMessage(s);this.gamePlay.showCellTooltip(e,t)}if(this.gameState.unitAssign){this.gameState.cursorStatus=!0,this.gamePlay.setCursor(f.pointer);const i=a(t,this.gameState.matrix),n=Math.abs(i.X-this.gameState.point.X),l=Math.abs(i.Y-this.gameState.point.Y),{step:o}=this.gameState;if(s){const{stepAttack:a}=this.gameState;e.includes(s.character.type)&&(n>a||l>a?(this.gamePlay.setCursor(f.notallowed),this.gameState.cursorStatus=!1):(this.gamePlay.setCursor(f.crosshair),this.gamePlay.selectCell(t,"red")))}else n<=o&&this.gameState.point.Y===i.Y||l<=o&&this.gameState.point.X===i.X||n<=o&&n===l?this.gamePlay.selectCell(t,"green"):(this.gamePlay.setCursor(f.notallowed),this.gameState.cursorStatus=!1)}}onCellLeave(t){this.gamePlay.hideCellTooltip(t),this.gamePlay.setCursor(f.auto);const e=[...this.gameState.players,...this.gameState.enemies].find(e=>e.position===t);if(this.gameState.unitAssign){if(e&&t===this.gameState.lostIndex)return;this.gamePlay.deselectCell(t)}}onNewGame(){console.log("Начать новую игру"),console.log("Текущие показатели",this.gameState);const{score:t,maxScore:e}=this.gameState;this.gameState=new y,this.gameState.maxScore=t>e?t:e,this.gameState.newGame=!0,console.log("Текущие показатели после очистки",this.gameState),this.init()}onSaveGame(){this.stateService.save(this.gameState),console.log("Игра сохранена!!!")}onLoadGame(){console.log("!!!!!!!!! Загрузка игры !!!!!!!!!!");const t=this.stateService.load();this.gameState.from(t),console.log("this.gameState",this.gameState);const{level:e}=this.gameState,{countThemes:s}=this.gameState,a=Object.values(v),i=e-1-s*a.length;console.log("index",i,e,s);const n=a[i];console.log("theme",n),Number.isInteger(e/a.length)&&(this.gameState.countThemes+=1),this.gamePlay.drawUi(n);const{players:l}=this.gameState,{enemies:o}=this.gameState;this.gamePlay.redrawPositions([...l,...o])}static assignPositions(t,e){const s=[];for(let a=0;a<t.characters.length;a+=1){const i=t.characters[a],n=Math.floor(Math.random()*e.length),l=e[n];e.splice(n,1);const o=new S(i,l);s.push(o)}return s}static getMessage(t){const{level:e}=t.character,{attack:s}=t.character,{defence:a}=t.character,{health:i}=t.character;return`🎖 ${e} ⚔ ${s} 🛡 ${a} ❤ ${i}`}attackOnUnit(t,e,s){let a=t.find(t=>t.position===this.gameState.lostIndex);a=a.character;let i=t.find(t=>t.position===e);console.log("Сейчас атакуют:",i);const n=t.indexOf(i);i=i.character;let l=Math.max(a.attack-i.defence,.1*a.attack);l=Number(l.toFixed(1));const o=this.gamePlay.showDamage(e,l);this.gameState.animation=!0;const{health:r}=t[n].character;[...t][n].character.health=Number((r-l).toFixed(1));const{lostIndex:h}=this.gameState;o.then(()=>{if(this.gamePlay.redrawPositions(t),this.gameState.animation=!1,t[n].character.health<=0){t.splice(n,1),this.gamePlay.redrawPositions(t);const a=s.enemy.find(t=>t.position===e),i=s.enemy.indexOf(a);console.log("Зашли в раздел"),this.gameState.stepUser?(this.gameState.score+=100*a.character.level,this.gameState.enemies.splice(i,1)):this.gameState.players.splice(i,1),console.log("Unit погибает")}this.gameState.stepUser?this.gameState.stepUser=!1:this.gameState.stepUser=!0,console.log("Прошла асинхронка",this.gameState),this.gameState.stepUser||(console.log("-----------------------------"),console.log("Ходит противник"),this.stepComputer())}),this.gameState.lostIndex=-1,this.gameState.unitAssign=!1,this.gameState.point={X:null,Y:null},this.gameState.step=void 0,this.gameState.stepAttack=void 0,this.gamePlay.setCursor(f.auto),this.gamePlay.deselectCell(h),this.gamePlay.deselectCell(e)}stepComputer(){if(console.log("Живые противники",this.gameState.enemies.length),0===this.gameState.enemies.length)return console.log("Все противники погибли"),this.gameState.stepUser=!0,this.upgradeUnits(),this.gameState.playerVictory=!0,this.gameState.level+=1,void this.init();const t=this.inviteUnit(),e=a(t.position,this.gameState.matrix);this.onCellClick(t.position);const s=this.countDistance(e),i=a(s.position,this.gameState.matrix);if(s.distance<=0)return void this.onCellClick(this.gameState.matrix[i.X][i.Y]);const n=function(t,e){let s;return t.distance,e.character.stepAttack,s=t.distance,t.distance>e.character.step&&(s=e.character.step),s}(s,t),{x:l,y:o}=this.getCordsMove(e,i,n);this.onCellClick(this.gameState.matrix[l][o])}upgradeUnits(){console.log("**************** Повышение уровней *********************"),console.log("Новый уровень",this.gameState);for(let t=0;t<this.gameState.players.length;t+=1){const e=this.gameState.players[t];o.levelUp.call(e.character,1)}this.gamePlay.redrawPositions(this.gameState.players)}inviteUnit(){const t={1:"undead",2:"vampire",3:"daemon"};let e;const{enemies:s}=this.gameState;for(const a in t)if(Object.prototype.hasOwnProperty.call(t,a)&&(e=s.filter(e=>e.character.type===t[a]),e.length>0))break;return e.sort(i),e[0]}countDistance(t){const e=this.gameState.players,s=[];return e.forEach(e=>{const i=a(e.position,this.gameState.matrix),n=Math.abs(t.X-i.X),l=Math.abs(t.Y-i.Y);let o;o=n<=this.gameState.stepAttack?l-this.gameState.stepAttack:l<=this.gameState.stepAttack?n-this.gameState.stepAttack:n-this.gameState.stepAttack+l-this.gameState.stepAttack,s.push({distance:o,position:e.position})}),s.sort(n),s[0]}getCordsMove(t,e,s){const a=t.X-e.X,i=t.Y-e.Y,n=Math.abs(a),l=Math.abs(i),o=this.gameState.stepAttack;let r,h;return n-o<=0?(r=t.X,h=t.Y>e.Y?t.Y-s:t.Y+s):l-o<=0?(h=t.Y,r=t.X>e.X?t.X-s:t.X+s):n-o>=s&&l-o>=s?(r=a>0?t.X-s:t.X+s,h=i>0?t.Y-s:t.Y+s):n-o>=l-o?(h=t.Y,r=t.X>e.X?t.X-s:t.X+s):(r=t.X,h=t.Y>e.Y?t.Y-s:t.Y+s),r=r<0?0:r,h=h<0?0:h,{x:r,y:h}}}const b=new l;b.bindToDOM(document.querySelector("#game-container"));const w=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage);new C(b,w).init()}]);